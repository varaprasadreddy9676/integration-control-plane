version: '3.8'

services:
  # Main Gateway Application
  gateway:
    build:
      context: .
      dockerfile: Dockerfile
    image: medics-gateway:latest
    container_name: medics-gateway
    restart: unless-stopped

    # Resource limits - adjust based on your server
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

    # Environment variables
    environment:
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=6144 --max-semi-space-size=128
      - PORT=4000

    # Port mapping
    ports:
      - "4000:4000"

    # Mount config and logs
    volumes:
      - ./config.docker.json:/app/config.json:ro
      - ./logs:/app/logs
      - /etc/localtime:/etc/localtime:ro

    # Network
    networks:
      - medics-network

    # Dependencies
    depends_on:
      mongodb:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MongoDB Database
  mongodb:
    image: mongo:6.0
    container_name: medics-mongodb
    restart: unless-stopped

    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-medics_integration_gateway}

    # Port mapping (optional)
    ports:
      - "27017:27017"

    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb

    networks:
      - medics-network

    # MongoDB configuration
    command: >
      --auth
      --wiredTigerCacheSizeGB=2

    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis (optional - for caching/rate limiting)
  redis:
    image: redis:7-alpine
    container_name: medics-redis
    restart: unless-stopped

    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru

    ports:
      - "6379:6379"

    volumes:
      - redis-data:/data

    networks:
      - medics-network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx Reverse Proxy (optional - for load balancing)
  nginx:
    image: nginx:alpine
    container_name: medics-nginx
    restart: unless-stopped

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx

    networks:
      - medics-network

    depends_on:
      - gateway

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  medics-network:
    driver: bridge

volumes:
  mongodb-data:
    driver: local
  mongodb-config:
    driver: local
  redis-data:
    driver: local
