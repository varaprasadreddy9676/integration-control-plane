[{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910dd"
  },
  "name": "CleverTap - Advance Created",
  "direction": "OUTBOUND",
  "type": "ADVANCE_CREATED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910c7"
  },
  "name": "CleverTap - Appointment Cancellation",
  "direction": "OUTBOUND",
  "type": "APPOINTMENT_CANCELLATION",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910c4"
  },
  "name": "CleverTap - Appointment Confirmation",
  "direction": "OUTBOUND",
  "type": "APPOINTMENT_CONFIRMATION",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "actions": [
    {
      "name": "Profile Upload",
      "direction": "OUTBOUND",
      "targetUrl": "https://api.clevertap.com/1/upload",
      "httpMethod": "POST",
      "transformationMode": "SCRIPT",
      "transformation": {
        "script": "const MONTH_MAP = { 'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5, 'jul': 6, 'aug': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11 };\n\nconst parseDate = (input) => {\n  if (!input) return null;\n  try {\n    if (typeof input === 'number') {\n      if (input > 10000000000) {\n        return new Date(input);\n      } else {\n        return new Date(input * 1000);\n      }\n    }\n    if (typeof input !== 'string') return null;\n    const str = input.trim();\n    if (str.includes('/')) {\n      const parts = str.split(' ');\n      const datePart = parts[0];\n      const [day, month, year] = datePart.split('/');\n      return new Date(year, month - 1, day);\n    } else if (/^\\d{1,2}-[A-Za-z]{3}-\\d{4}/.test(str)) {\n      const parts = str.split(/[\\s-]+/);\n      const day = parseInt(parts[0]);\n      const monthStr = parts[1].toLowerCase().substring(0, 3);\n      const year = parseInt(parts[2]);\n      const month = MONTH_MAP[monthStr];\n      if (month === undefined) return null;\n      return new Date(year, month, day);\n    } else if (/^\\d{1,2}-\\d{1,2}-\\d{4}/.test(str)) {\n      const parts = str.split(/[\\s-]+/);\n      const datePart = parts[0];\n      const [day, month, year] = datePart.split('-');\n      return new Date(year, month - 1, day);\n    } else if (/^\\d{4}-\\d{2}-\\d{2}\\s+\\d{1,2}:\\d{2}:\\d{2}/.test(str)) {\n      const match = str.match(/^(\\d{4})-(\\d{2})-(\\d{2})\\s+(\\d{1,2}):(\\d{2}):(\\d{2})/);\n      if (match) {\n        const [, year, month, day, hour, minute, second] = match;\n        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), parseInt(second));\n      }\n      return null;\n    } else if (/^\\d{4}-\\d{2}-\\d{2}T\\d{1,2}:\\d{2}:\\d{2}/.test(str)) {\n      const match = str.match(/^(\\d{4})-(\\d{2})-(\\d{2})T(\\d{1,2}):(\\d{2}):(\\d{2})/);\n      if (match) {\n        const [, year, month, day, hour, minute, second] = match;\n        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), parseInt(second));\n      }\n      return null;\n    } else if (/^\\d{4}-\\d{2}-\\d{2}/.test(str)) {\n      const match = str.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\n      if (match) {\n        const [, year, month, day] = match;\n        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));\n      }\n      return null;\n    }\n    return null;\n  } catch (e) {\n    return null;\n  }\n};\n\nlet phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\n\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst profileData = {\n  'MSG-sms': true,\n  'MSG-email': true,\n  'MSG-whatsapp': true,\n  'MSG-push': true,\n  'MSG-dndPhone': false,\n  'MSG-dndEmail': false,\n  'MSG-dndWhatsApp': false\n};\n\nif (phone) {\n  profileData.Phone = phone;\n}\n\nconst name = payload.patient?.fullName || payload.patientName || payload.name;\nif (name) {\n  profileData.Name = name;\n}\n\nconst email = payload.patient?.email || payload.patientEmail || payload.email;\nif (email) {\n  profileData.Email = email;\n}\n\nconst mrn = payload.patient?.mrn?.documentNumber || payload.patientMRN || payload.mrn;\nif (mrn) {\n  profileData.MRN = mrn;\n}\n\nconst mrnSeq = payload.patient?.mrn?.sequenceNumber;\nif (mrnSeq) {\n  profileData['MRN Sequence'] = mrnSeq;\n}\n\nif (payload.uhid) {\n  profileData.UHID = payload.uhid;\n}\n\nconst gender = (payload.patient?.gender || payload.gender || '');\nif (gender) {\n  profileData.Gender = gender.charAt(0).toUpperCase();\n}\n\nconst address = payload.patient?.address || payload.address;\nif (address) {\n  profileData.Address = address;\n}\n\nif (payload.city) {\n  profileData.City = payload.city;\n}\n\nif (payload.state) {\n  profileData.State = payload.state;\n}\n\nconst age = payload.patient?.age || payload.age;\nif (age) {\n  profileData.Age = age;\n  const birthYear = new Date().getFullYear() - age;\n  profileData.DOB = '$D_' + Math.floor(new Date(birthYear, 0, 1).getTime() / 1000);\n}\n\nconst patientDob = payload.patient?.dob || payload.patient?.dateOfBirth || payload.dob;\nif (patientDob && !profileData.DOB) {\n  // PRESERVE original DOB string\n  profileData['DOB Original'] = patientDob;\n  // ADD epoch version\n  const dobDate = parseDate(patientDob);\n  if (dobDate) {\n    profileData.DOB = '$D_' + Math.floor(dobDate.getTime() / 1000);\n  }\n}\n\nprofileData['Is VIP'] = payload.patient?.isVIP || false;\nprofileData['Is International'] = payload.patient?.isInternational || false;\nprofileData['Is Mobile Verified'] = payload.patient?.isMobileNoVerified || false;\n\nconst lastVisitDate = payload.visit?.date || payload.visitDate;\nif (lastVisitDate) {\n  // PRESERVE original visit date\n  profileData['Last Visit Date Original'] = lastVisitDate;\n  // ADD epoch version\n  const visitDate = parseDate(lastVisitDate);\n  if (visitDate) {\n    profileData['Last Visit Date'] = '$D_' + Math.floor(visitDate.getTime() / 1000);\n  }\n}\n\nprofileData['Patient Source'] = 'source-system';\n\nif (payload.entityName) {\n  profileData['Entity Name'] = payload.entityName;\n}\n\nif (payload.entityCode) {\n  profileData['Entity Code'] = payload.entityCode;\n}\n\nreturn {\n  d: [{\n    identity: identity,\n    type: 'profile',\n    profileData: profileData\n  }]\n};"
      }
    },
    {
      "name": "Event Upload",
      "direction": "OUTBOUND",
      "targetUrl": "https://api.clevertap.com/1/upload",
      "httpMethod": "POST",
      "transformationMode": "SCRIPT",
      "transformation": {
        "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\n// Helper function to dynamically add all fields from an object\nconst addDynamicFields = (target, source, prefix = '') => {\n  if (!source || typeof source !== 'object') return;\n\n  Object.keys(source).forEach(key => {\n    const value = source[key];\n    const fieldName = prefix ? `${prefix} ${key}` : key;\n\n    // Skip if already exists (explicit mappings take precedence)\n    if (target[fieldName] !== undefined) return;\n\n    // Handle primitive values\n    if (value === null || value === undefined) return;\n\n    if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\n      target[fieldName] = value;\n    } else if (Array.isArray(value)) {\n      // Store arrays as JSON string\n      target[fieldName] = JSON.stringify(value);\n    } else if (typeof value === 'object') {\n      // For nested objects, flatten one level with dot notation\n      Object.keys(value).forEach(nestedKey => {\n        const nestedValue = value[nestedKey];\n        const nestedFieldName = `${fieldName}.${nestedKey}`;\n\n        if (target[nestedFieldName] !== undefined) return;\n\n        if (typeof nestedValue === 'string' || typeof nestedValue === 'number' || typeof nestedValue === 'boolean') {\n          target[nestedFieldName] = nestedValue;\n        }\n      });\n    }\n  });\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description\n};\n\n// STEP 1: DYNAMICALLY add all root-level fields from payload\naddDynamicFields(evtData, payload);\n\n// STEP 2: EXPLICIT mappings (these override dynamic ones)\n\n// PRESERVE original datetime, ADD epoch\nif (payload.datetime) {\n  evtData['Event DateTime'] = payload.datetime;\n  addEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n}\n\n// Patient fields (explicit mappings with proper naming)\nif (payload.patient) {\n  // First add all patient fields dynamically\n  addDynamicFields(evtData, payload.patient, 'Patient');\n\n  // Then override with explicit mappings for important fields\n  if (payload.patient.fullName) evtData['Patient Name'] = payload.patient.fullName;\n  if (payload.patient.phone) evtData['Patient Phone'] = payload.patient.phone;\n  if (payload.patient.email) evtData['Patient Email'] = payload.patient.email;\n  if (payload.patient.address) evtData['Patient Address'] = payload.patient.address;\n  if (payload.patient.gender) evtData['Patient Gender'] = payload.patient.gender;\n  if (payload.patient.mrn?.documentNumber) evtData['Patient MRN'] = payload.patient.mrn.documentNumber;\n  if (payload.patient.mrn?.sequenceNumber) evtData['Patient MRN Sequence'] = payload.patient.mrn.sequenceNumber;\n  evtData['Is VIP'] = payload.patient.isVIP || false;\n  evtData['Is International'] = payload.patient.isInternational || false;\n  evtData['Is Mobile Verified'] = payload.patient.isMobileNoVerified || false;\n}\n\n// APPOINTMENT_CONFIRMATION specific fields\nif (payload.appt) {\n  // First add all appointment fields dynamically\n  addDynamicFields(evtData, payload.appt, 'Appointment');\n\n  // Then explicit mappings for important appointment fields\n  if (payload.appt.apptRID) evtData['Appointment ID'] = payload.appt.apptRID;\n  if (payload.appt.bookingNumber) evtData['Booking Number'] = payload.appt.bookingNumber;\n  if (payload.appt.apptStatusName) evtData['Appointment Status'] = payload.appt.apptStatusName;\n  if (payload.appt.apptTypeName) evtData['Appointment Type'] = payload.appt.apptTypeName;\n  if (payload.appt.serviceProviderName) evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  if (payload.appt.serviceProviderPhone) evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  if (payload.appt.serviceProviderRID) evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  if (payload.appt.resourceName) evtData['Resource Name'] = payload.appt.resourceName;\n  if (payload.appt.consultationFee) evtData['Consultation Fee'] = payload.appt.consultationFee;\n  if (payload.appt.bookingSource) evtData['Booking Source'] = payload.appt.bookingSource;\n  if (payload.appt.isVideoConsultation !== undefined) evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  if (payload.appt.paymentStatus) evtData['Payment Status'] = payload.appt.paymentStatus;\n  if (payload.appt.tokenNumber) evtData['Token Number'] = payload.appt.tokenNumber;\n  if (payload.appt.apptDuration) evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n\n  // PRESERVE original date/time, ADD epoch\n  if (payload.appt.apptDate) {\n    evtData['Appointment Date'] = payload.appt.apptDate;\n    if (payload.appt.apptTime) {\n      evtData['Appointment Time'] = payload.appt.apptTime;\n      addEpochField(evtData, 'Appointment DateTime_epoch', payload.appt.apptDate, payload.appt.apptTime);\n    }\n  }\n}\n\n// Visit data (if present with appointment)\nif (payload.visit) {\n  // Add visit fields dynamically with prefix\n  addDynamicFields(evtData, payload.visit, 'Visit');\n\n  // Explicit mappings for important visit fields\n  if (payload.visit.speciality?.name) evtData['Speciality'] = payload.visit.speciality.name;\n  if (payload.visit.referredBy) evtData['Referred By'] = payload.visit.referredBy;\n}\n\n// Clean up null/undefined values\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };"
      }
    }
  ],
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:18:00.970Z"
  },
  "updatedAt": {
    "$date": "2026-02-13T05:32:32.831Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910c8"
  },
  "name": "CleverTap - Appointment Rescheduled",
  "direction": "OUTBOUND",
  "type": "APPOINTMENT_RESCHEDULED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910d5"
  },
  "name": "CleverTap - Beta HCG Record",
  "direction": "OUTBOUND",
  "type": "BETA_HCG_RECORD",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910c9"
  },
  "name": "CleverTap - Bill Created",
  "direction": "OUTBOUND",
  "type": "BILL_CREATED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:20:15.206Z"
  },
  "updatedAt": {
    "$date": "2026-02-10T13:20:15.206Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910d7"
  },
  "name": "CleverTap - Clinical Pregnancy",
  "direction": "OUTBOUND",
  "type": "CLINICAL_PREGNANCY",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:19:59.989Z"
  },
  "updatedAt": {
    "$date": "2026-02-10T13:19:59.989Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910cb"
  },
  "name": "CleverTap - Consent Received",
  "direction": "OUTBOUND",
  "type": "CONSENT_RECEIVED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:19:10.157Z"
  },
  "updatedAt": {
    "$date": "2026-02-10T13:19:10.157Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910d6"
  },
  "name": "CleverTap - Cycle Completed",
  "direction": "OUTBOUND",
  "type": "CYCLE_COMPLETED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910dc"
  },
  "name": "CleverTap - Cycle Stopped",
  "direction": "OUTBOUND",
  "type": "CYCLE_STOPPED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-13T05:13:27.659Z"
  },
  "updatedAt": {
    "$date": "2026-02-13T05:13:27.659Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910d4"
  },
  "name": "CleverTap - ET Done",
  "direction": "OUTBOUND",
  "type": "ET_DONE",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-09T18:20:57.656Z"
  },
  "updatedAt": {
    "$date": "2026-02-09T18:20:57.656Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910d3"
  },
  "name": "CleverTap - ET Schedule",
  "direction": "OUTBOUND",
  "type": "ET_SCHEDULE",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910e0"
  },
  "name": "CleverTap - Issue Created",
  "direction": "OUTBOUND",
  "type": "ISSUE_CREATED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910da"
  },
  "name": "CleverTap - IUI Recorded",
  "direction": "OUTBOUND",
  "type": "IUI_RECORDED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-13T05:13:27.317Z"
  },
  "updatedAt": {
    "$date": "2026-02-13T05:13:27.317Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910d9"
  },
  "name": "CleverTap - IUI Schedule",
  "direction": "OUTBOUND",
  "type": "IUI_SCHEDULE",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910df"
  },
  "name": "CleverTap - Lab Result Signed",
  "direction": "OUTBOUND",
  "type": "LAB_RESULT_SIGNED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910d8"
  },
  "name": "CleverTap - Live Birth",
  "direction": "OUTBOUND",
  "type": "LIVE_BIRTH",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910db"
  },
  "name": "CleverTap - Miscarriage Recorded",
  "direction": "OUTBOUND",
  "type": "MISCARRIAGE_RECORDED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-13T05:13:27.485Z"
  },
  "updatedAt": {
    "$date": "2026-02-13T05:13:27.485Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910d2"
  },
  "name": "CleverTap - OPU Done",
  "direction": "OUTBOUND",
  "type": "OPU_DONE",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-09T18:20:47.662Z"
  },
  "updatedAt": {
    "$date": "2026-02-09T18:20:47.662Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910d0"
  },
  "name": "CleverTap - OPU or IUI Trigger Schedule",
  "direction": "OUTBOUND",
  "type": "OPU_OR_IUI_TRIGGER_SCHEDULE",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910d1"
  },
  "name": "CleverTap - OPU Schedule",
  "direction": "OUTBOUND",
  "type": "OPU_SCHEDULE",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910c6"
  },
  "name": "CleverTap - OP Referral Doctor Event",
  "direction": "OUTBOUND",
  "type": "OP_REFERRAL_DOCTOR_EVENT",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910c3"
  },
  "name": "CleverTap - OP Visit Created",
  "direction": "OUTBOUND",
  "type": "OP_VISIT_CREATED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "actions": [
    {
      "name": "Profile Upload",
      "direction": "OUTBOUND",
      "targetUrl": "https://api.clevertap.com/1/upload",
      "httpMethod": "POST",
      "transformationMode": "SCRIPT",
      "transformation": {
        "script": "const MONTH_MAP = { 'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5, 'jul': 6, 'aug': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11 };\n\nconst parseDate = (input) => {\n  if (!input) return null;\n  try {\n    if (typeof input === 'number') {\n      if (input > 10000000000) {\n        return new Date(input);\n      } else {\n        return new Date(input * 1000);\n      }\n    }\n    if (typeof input !== 'string') return null;\n    const str = input.trim();\n    if (str.includes('/')) {\n      const parts = str.split(' ');\n      const datePart = parts[0];\n      const [day, month, year] = datePart.split('/');\n      return new Date(year, month - 1, day);\n    } else if (/^\\d{1,2}-[A-Za-z]{3}-\\d{4}/.test(str)) {\n      const parts = str.split(/[\\s-]+/);\n      const day = parseInt(parts[0]);\n      const monthStr = parts[1].toLowerCase().substring(0, 3);\n      const year = parseInt(parts[2]);\n      const month = MONTH_MAP[monthStr];\n      if (month === undefined) return null;\n      return new Date(year, month, day);\n    } else if (/^\\d{1,2}-\\d{1,2}-\\d{4}/.test(str)) {\n      const parts = str.split(/[\\s-]+/);\n      const datePart = parts[0];\n      const [day, month, year] = datePart.split('-');\n      return new Date(year, month - 1, day);\n    } else if (/^\\d{4}-\\d{2}-\\d{2}\\s+\\d{1,2}:\\d{2}:\\d{2}/.test(str)) {\n      const match = str.match(/^(\\d{4})-(\\d{2})-(\\d{2})\\s+(\\d{1,2}):(\\d{2}):(\\d{2})/);\n      if (match) {\n        const [, year, month, day, hour, minute, second] = match;\n        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), parseInt(second));\n      }\n      return null;\n    } else if (/^\\d{4}-\\d{2}-\\d{2}T\\d{1,2}:\\d{2}:\\d{2}/.test(str)) {\n      const match = str.match(/^(\\d{4})-(\\d{2})-(\\d{2})T(\\d{1,2}):(\\d{2}):(\\d{2})/);\n      if (match) {\n        const [, year, month, day, hour, minute, second] = match;\n        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), parseInt(second));\n      }\n      return null;\n    } else if (/^\\d{4}-\\d{2}-\\d{2}/.test(str)) {\n      const match = str.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\n      if (match) {\n        const [, year, month, day] = match;\n        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));\n      }\n      return null;\n    }\n    return null;\n  } catch (e) {\n    return null;\n  }\n};\n\nlet phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\n\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst profileData = {\n  'MSG-sms': true,\n  'MSG-email': true,\n  'MSG-whatsapp': true,\n  'MSG-push': true,\n  'MSG-dndPhone': false,\n  'MSG-dndEmail': false,\n  'MSG-dndWhatsApp': false\n};\n\nif (phone) {\n  profileData.Phone = phone;\n}\n\nconst name = payload.patient?.fullName || payload.patientName || payload.name;\nif (name) {\n  profileData.Name = name;\n}\n\nconst email = payload.patient?.email || payload.patientEmail || payload.email;\nif (email) {\n  profileData.Email = email;\n}\n\nconst mrn = payload.patient?.mrn?.documentNumber || payload.patientMRN || payload.mrn;\nif (mrn) {\n  profileData.MRN = mrn;\n}\n\nconst mrnSeq = payload.patient?.mrn?.sequenceNumber;\nif (mrnSeq) {\n  profileData['MRN Sequence'] = mrnSeq;\n}\n\nif (payload.uhid) {\n  profileData.UHID = payload.uhid;\n}\n\nconst gender = (payload.patient?.gender || payload.gender || '');\nif (gender) {\n  profileData.Gender = gender.charAt(0).toUpperCase();\n}\n\nconst address = payload.patient?.address || payload.address;\nif (address) {\n  profileData.Address = address;\n}\n\nif (payload.city) {\n  profileData.City = payload.city;\n}\n\nif (payload.state) {\n  profileData.State = payload.state;\n}\n\nconst age = payload.patient?.age || payload.age;\nif (age) {\n  profileData.Age = age;\n  const birthYear = new Date().getFullYear() - age;\n  profileData.DOB = '$D_' + Math.floor(new Date(birthYear, 0, 1).getTime() / 1000);\n}\n\nconst patientDob = payload.patient?.dob || payload.patient?.dateOfBirth || payload.dob;\nif (patientDob && !profileData.DOB) {\n  // PRESERVE original DOB string\n  profileData['DOB Original'] = patientDob;\n  // ADD epoch version\n  const dobDate = parseDate(patientDob);\n  if (dobDate) {\n    profileData.DOB = '$D_' + Math.floor(dobDate.getTime() / 1000);\n  }\n}\n\nprofileData['Is VIP'] = payload.patient?.isVIP || false;\nprofileData['Is International'] = payload.patient?.isInternational || false;\nprofileData['Is Mobile Verified'] = payload.patient?.isMobileNoVerified || false;\n\nconst lastVisitDate = payload.visit?.date || payload.visitDate;\nif (lastVisitDate) {\n  // PRESERVE original visit date\n  profileData['Last Visit Date Original'] = lastVisitDate;\n  // ADD epoch version\n  const visitDate = parseDate(lastVisitDate);\n  if (visitDate) {\n    profileData['Last Visit Date'] = '$D_' + Math.floor(visitDate.getTime() / 1000);\n  }\n}\n\nprofileData['Patient Source'] = 'source-system';\n\nif (payload.entityName) {\n  profileData['Entity Name'] = payload.entityName;\n}\n\nif (payload.entityCode) {\n  profileData['Entity Code'] = payload.entityCode;\n}\n\nreturn {\n  d: [{\n    identity: identity,\n    type: 'profile',\n    profileData: profileData\n  }]\n};"
      }
    },
    {
      "name": "Event Upload",
      "direction": "OUTBOUND",
      "targetUrl": "https://api.clevertap.com/1/upload",
      "httpMethod": "POST",
      "transformationMode": "SCRIPT",
      "transformation": {
        "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\n// Helper function to dynamically add all fields from an object\nconst addDynamicFields = (target, source, prefix = '') => {\n  if (!source || typeof source !== 'object') return;\n\n  Object.keys(source).forEach(key => {\n    const value = source[key];\n    const fieldName = prefix ? `${prefix} ${key}` : key;\n\n    // Skip if already exists (explicit mappings take precedence)\n    if (target[fieldName] !== undefined) return;\n\n    // Handle primitive values\n    if (value === null || value === undefined) return;\n\n    if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\n      target[fieldName] = value;\n    } else if (Array.isArray(value)) {\n      // Store arrays as JSON string\n      target[fieldName] = JSON.stringify(value);\n    } else if (typeof value === 'object') {\n      // For nested objects, flatten one level with dot notation\n      Object.keys(value).forEach(nestedKey => {\n        const nestedValue = value[nestedKey];\n        const nestedFieldName = `${fieldName}.${nestedKey}`;\n\n        if (target[nestedFieldName] !== undefined) return;\n\n        if (typeof nestedValue === 'string' || typeof nestedValue === 'number' || typeof nestedValue === 'boolean') {\n          target[nestedFieldName] = nestedValue;\n        }\n      });\n    }\n  });\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description\n};\n\n// STEP 1: DYNAMICALLY add all root-level fields from payload\naddDynamicFields(evtData, payload);\n\n// STEP 2: EXPLICIT mappings (these override dynamic ones)\n\n// PRESERVE original datetime, ADD epoch\nif (payload.datetime) {\n  evtData['Event DateTime'] = payload.datetime;\n  addEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n}\n\n// Patient fields (explicit mappings with proper naming)\nif (payload.patient) {\n  // First add all patient fields dynamically\n  addDynamicFields(evtData, payload.patient, 'Patient');\n\n  // Then override with explicit mappings for important fields\n  if (payload.patient.fullName) evtData['Patient Name'] = payload.patient.fullName;\n  if (payload.patient.phone) evtData['Patient Phone'] = payload.patient.phone;\n  if (payload.patient.email) evtData['Patient Email'] = payload.patient.email;\n  if (payload.patient.address) evtData['Patient Address'] = payload.patient.address;\n  if (payload.patient.gender) evtData['Patient Gender'] = payload.patient.gender;\n  if (payload.patient.mrn?.documentNumber) evtData['Patient MRN'] = payload.patient.mrn.documentNumber;\n  if (payload.patient.mrn?.sequenceNumber) evtData['Patient MRN Sequence'] = payload.patient.mrn.sequenceNumber;\n  evtData['Is VIP'] = payload.patient.isVIP || false;\n  evtData['Is International'] = payload.patient.isInternational || false;\n  evtData['Is Mobile Verified'] = payload.patient.isMobileNoVerified || false;\n}\n\n// OP_VISIT_CREATED specific fields\nif (payload.visit) {\n  // First add all visit fields dynamically\n  addDynamicFields(evtData, payload.visit, 'Visit');\n\n  // Then explicit mappings for important visit fields\n  if (payload.visit.id?.value) evtData['Visit ID'] = payload.visit.id.value;\n  if (payload.visit.leadNo) evtData['Lead No'] = payload.visit.leadNo;\n  if (payload.visit.typeName) evtData['Visit Type'] = payload.visit.typeName;\n  if (payload.visit.statusName) evtData['Visit Status'] = payload.visit.statusName;\n  if (payload.visit.visitNumber?.documentNumber) evtData['Visit Number'] = payload.visit.visitNumber.documentNumber;\n  if (payload.visit.speciality?.name) evtData['Speciality'] = payload.visit.speciality.name;\n  if (payload.visit.referredBy) evtData['Referred By'] = payload.visit.referredBy;\n  if (payload.visit.consultingDoctor?.value) evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor.value;\n  if (payload.visit.leadRemarks) evtData['Lead Remarks'] = payload.visit.leadRemarks;\n  if (payload.visit.patientMRN) evtData['Visit Patient MRN'] = payload.visit.patientMRN;\n  if (payload.visit.sealed !== undefined) evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.sourceSystemId !== undefined) evtData['Visit source system ID'] = payload.visit.sourceSystemId;\n  if (payload.visit.sourceAppointmentId !== undefined) evtData['Appointment ID'] = payload.visit.sourceAppointmentId;\n  if (payload.visit.visitCategory !== undefined) evtData['Visit Category'] = payload.visit.visitCategory;\n  if (payload.visit.patientAgeInDays !== undefined) evtData['Patient Age In Days'] = payload.visit.patientAgeInDays;\n  if (payload.visit.patientAgeInYears !== undefined) evtData['Patient Age In Years'] = payload.visit.patientAgeInYears;\n  if (payload.visit.patientAgeInMonths !== undefined) evtData['Patient Age In Months'] = payload.visit.patientAgeInMonths;\n\n  // PRESERVE original date/time, ADD epoch\n  if (payload.visit.date) {\n    evtData['Visit Date'] = payload.visit.date;\n    if (payload.visit.time) evtData['Visit Time'] = payload.visit.time;\n    addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\n// Clean up null/undefined values\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };"
      }
    }
  ],
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:19:40.239Z"
  },
  "updatedAt": {
    "$date": "2026-02-13T05:32:32.831Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910c5"
  },
  "name": "CleverTap - OP Visit Modified",
  "direction": "OUTBOUND",
  "type": "OP_VISIT_MODIFIED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:20:29.736Z"
  },
  "updatedAt": {
    "$date": "2026-02-10T13:20:29.736Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910c2"
  },
  "name": "CleverTap - Patient Registered",
  "direction": "OUTBOUND",
  "type": "PATIENT_REGISTERED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "actions": [
    {
      "name": "Profile Upload",
      "direction": "OUTBOUND",
      "targetUrl": "https://api.clevertap.com/1/upload",
      "httpMethod": "POST",
      "transformationMode": "SCRIPT",
      "transformation": {
        "script": "const MONTH_MAP = { 'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5, 'jul': 6, 'aug': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11 };\n\nconst parseDate = (input) => {\n  if (!input) return null;\n  try {\n    if (typeof input === 'number') {\n      if (input > 10000000000) {\n        return new Date(input);\n      } else {\n        return new Date(input * 1000);\n      }\n    }\n    if (typeof input !== 'string') return null;\n    const str = input.trim();\n    if (str.includes('/')) {\n      const parts = str.split(' ');\n      const datePart = parts[0];\n      const [day, month, year] = datePart.split('/');\n      return new Date(year, month - 1, day);\n    } else if (/^\\d{1,2}-[A-Za-z]{3}-\\d{4}/.test(str)) {\n      const parts = str.split(/[\\s-]+/);\n      const day = parseInt(parts[0]);\n      const monthStr = parts[1].toLowerCase().substring(0, 3);\n      const year = parseInt(parts[2]);\n      const month = MONTH_MAP[monthStr];\n      if (month === undefined) return null;\n      return new Date(year, month, day);\n    } else if (/^\\d{1,2}-\\d{1,2}-\\d{4}/.test(str)) {\n      const parts = str.split(/[\\s-]+/);\n      const datePart = parts[0];\n      const [day, month, year] = datePart.split('-');\n      return new Date(year, month - 1, day);\n    } else if (/^\\d{4}-\\d{2}-\\d{2}\\s+\\d{1,2}:\\d{2}:\\d{2}/.test(str)) {\n      const match = str.match(/^(\\d{4})-(\\d{2})-(\\d{2})\\s+(\\d{1,2}):(\\d{2}):(\\d{2})/);\n      if (match) {\n        const [, year, month, day, hour, minute, second] = match;\n        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), parseInt(second));\n      }\n      return null;\n    } else if (/^\\d{4}-\\d{2}-\\d{2}T\\d{1,2}:\\d{2}:\\d{2}/.test(str)) {\n      const match = str.match(/^(\\d{4})-(\\d{2})-(\\d{2})T(\\d{1,2}):(\\d{2}):(\\d{2})/);\n      if (match) {\n        const [, year, month, day, hour, minute, second] = match;\n        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day), parseInt(hour), parseInt(minute), parseInt(second));\n      }\n      return null;\n    } else if (/^\\d{4}-\\d{2}-\\d{2}/.test(str)) {\n      const match = str.match(/^(\\d{4})-(\\d{2})-(\\d{2})/);\n      if (match) {\n        const [, year, month, day] = match;\n        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));\n      }\n      return null;\n    }\n    return null;\n  } catch (e) {\n    return null;\n  }\n};\n\nlet phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\n\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst profileData = {\n  'MSG-sms': true,\n  'MSG-email': true,\n  'MSG-whatsapp': true,\n  'MSG-push': true,\n  'MSG-dndPhone': false,\n  'MSG-dndEmail': false,\n  'MSG-dndWhatsApp': false\n};\n\nif (phone) {\n  profileData.Phone = phone;\n}\n\nconst name = payload.patient?.fullName || payload.patientName || payload.name;\nif (name) {\n  profileData.Name = name;\n}\n\nconst email = payload.patient?.email || payload.patientEmail || payload.email;\nif (email) {\n  profileData.Email = email;\n}\n\nconst mrn = payload.patient?.mrn?.documentNumber || payload.patientMRN || payload.mrn;\nif (mrn) {\n  profileData.MRN = mrn;\n}\n\nconst mrnSeq = payload.patient?.mrn?.sequenceNumber;\nif (mrnSeq) {\n  profileData['MRN Sequence'] = mrnSeq;\n}\n\nif (payload.uhid) {\n  profileData.UHID = payload.uhid;\n}\n\nconst gender = (payload.patient?.gender || payload.gender || '');\nif (gender) {\n  profileData.Gender = gender.charAt(0).toUpperCase();\n}\n\nconst address = payload.patient?.address || payload.address;\nif (address) {\n  profileData.Address = address;\n}\n\nif (payload.city) {\n  profileData.City = payload.city;\n}\n\nif (payload.state) {\n  profileData.State = payload.state;\n}\n\nconst age = payload.patient?.age || payload.age;\nif (age) {\n  profileData.Age = age;\n  const birthYear = new Date().getFullYear() - age;\n  profileData.DOB = '$D_' + Math.floor(new Date(birthYear, 0, 1).getTime() / 1000);\n}\n\nconst patientDob = payload.patient?.dob || payload.patient?.dateOfBirth || payload.dob;\nif (patientDob && !profileData.DOB) {\n  // PRESERVE original DOB string\n  profileData['DOB Original'] = patientDob;\n  // ADD epoch version\n  const dobDate = parseDate(patientDob);\n  if (dobDate) {\n    profileData.DOB = '$D_' + Math.floor(dobDate.getTime() / 1000);\n  }\n}\n\nprofileData['Is VIP'] = payload.patient?.isVIP || false;\nprofileData['Is International'] = payload.patient?.isInternational || false;\nprofileData['Is Mobile Verified'] = payload.patient?.isMobileNoVerified || false;\n\nconst lastVisitDate = payload.visit?.date || payload.visitDate;\nif (lastVisitDate) {\n  // PRESERVE original visit date\n  profileData['Last Visit Date Original'] = lastVisitDate;\n  // ADD epoch version\n  const visitDate = parseDate(lastVisitDate);\n  if (visitDate) {\n    profileData['Last Visit Date'] = '$D_' + Math.floor(visitDate.getTime() / 1000);\n  }\n}\n\nprofileData['Patient Source'] = 'source-system';\n\nif (payload.entityName) {\n  profileData['Entity Name'] = payload.entityName;\n}\n\nif (payload.entityCode) {\n  profileData['Entity Code'] = payload.entityCode;\n}\n\nreturn {\n  d: [{\n    identity: identity,\n    type: 'profile',\n    profileData: profileData\n  }]\n};"
      }
    },
    {
      "name": "Event Upload",
      "direction": "OUTBOUND",
      "targetUrl": "https://api.clevertap.com/1/upload",
      "httpMethod": "POST",
      "transformationMode": "SCRIPT",
      "transformation": {
        "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\n// Helper function to dynamically add all fields from an object\nconst addDynamicFields = (target, source, prefix = '') => {\n  if (!source || typeof source !== 'object') return;\n\n  Object.keys(source).forEach(key => {\n    const value = source[key];\n    const fieldName = prefix ? `${prefix} ${key}` : key;\n\n    // Skip if already exists (explicit mappings take precedence)\n    if (target[fieldName] !== undefined) return;\n\n    // Handle primitive values\n    if (value === null || value === undefined) return;\n\n    if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\n      target[fieldName] = value;\n    } else if (Array.isArray(value)) {\n      // Store arrays as JSON string\n      target[fieldName] = JSON.stringify(value);\n    } else if (typeof value === 'object') {\n      // For nested objects, flatten one level with dot notation\n      Object.keys(value).forEach(nestedKey => {\n        const nestedValue = value[nestedKey];\n        const nestedFieldName = `${fieldName}.${nestedKey}`;\n\n        if (target[nestedFieldName] !== undefined) return;\n\n        if (typeof nestedValue === 'string' || typeof nestedValue === 'number' || typeof nestedValue === 'boolean') {\n          target[nestedFieldName] = nestedValue;\n        }\n      });\n    }\n  });\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description\n};\n\n// STEP 1: DYNAMICALLY add all root-level fields from payload\naddDynamicFields(evtData, payload);\n\n// STEP 2: EXPLICIT mappings (these override dynamic ones)\n\n// PRESERVE original datetime, ADD epoch\nif (payload.datetime) {\n  evtData['Event DateTime'] = payload.datetime;\n  addEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n}\n\n// Patient fields (explicit mappings with proper naming)\nif (payload.patient) {\n  // First add all patient fields dynamically\n  addDynamicFields(evtData, payload.patient, 'Patient');\n\n  // Then override with explicit mappings for important fields\n  if (payload.patient.fullName) evtData['Patient Name'] = payload.patient.fullName;\n  if (payload.patient.phone) evtData['Patient Phone'] = payload.patient.phone;\n  if (payload.patient.email) evtData['Patient Email'] = payload.patient.email;\n  if (payload.patient.address) evtData['Patient Address'] = payload.patient.address;\n  if (payload.patient.gender) evtData['Patient Gender'] = payload.patient.gender;\n  if (payload.patient.mrn?.documentNumber) evtData['Patient MRN'] = payload.patient.mrn.documentNumber;\n  if (payload.patient.mrn?.sequenceNumber) evtData['Patient MRN Sequence'] = payload.patient.mrn.sequenceNumber;\n  evtData['Is VIP'] = payload.patient.isVIP || false;\n  evtData['Is International'] = payload.patient.isInternational || false;\n  evtData['Is Mobile Verified'] = payload.patient.isMobileNoVerified || false;\n}\n\n// PATIENT_REGISTERED specific: Add registration timestamp\nif (!evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\n\n// Visit data (if present during registration)\nif (payload.visit) {\n  // First add all visit fields dynamically\n  addDynamicFields(evtData, payload.visit, 'Visit');\n\n  // Then explicit mappings for important visit fields\n  if (payload.visit.id?.value) evtData['Visit ID'] = payload.visit.id.value;\n  if (payload.visit.typeName) evtData['Visit Type'] = payload.visit.typeName;\n  if (payload.visit.statusName) evtData['Visit Status'] = payload.visit.statusName;\n  if (payload.visit.sealed !== undefined) evtData['Visit Sealed'] = payload.visit.sealed;\n\n  // PRESERVE originals, ADD epochs\n  if (payload.visit.date) {\n    evtData['Visit Date'] = payload.visit.date;\n    if (payload.visit.time) evtData['Visit Time'] = payload.visit.time;\n    addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\n// Clean up null/undefined values\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };"
      }
    }
  ],
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:20:26.697Z"
  },
  "updatedAt": {
    "$date": "2026-02-13T05:32:32.831Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910de"
  },
  "name": "CleverTap - Receipt Created",
  "direction": "OUTBOUND",
  "type": "RECEIPT_CREATED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:20:14.904Z"
  },
  "updatedAt": {
    "$date": "2026-02-10T13:20:14.904Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910ce"
  },
  "name": "CleverTap - Stimulation Medication Recorded",
  "direction": "OUTBOUND",
  "type": "STIMULATION_MEDICATION_RECORDED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:19:14.680Z"
  },
  "updatedAt": {
    "$date": "2026-02-10T13:19:14.680Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910cf"
  },
  "name": "CleverTap - Stimulation Scan Recorded",
  "direction": "OUTBOUND",
  "type": "STIMULATION_SCAN_RECORDED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910cd"
  },
  "name": "CleverTap - Stimulation Started",
  "direction": "OUTBOUND",
  "type": "STIMULATION_STARTED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:19:10.223Z"
  },
  "updatedAt": {
    "$date": "2026-02-10T13:19:10.223Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910ca"
  },
  "name": "CleverTap - Treatment Advised",
  "direction": "OUTBOUND",
  "type": "TREATMENT_ADVISED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:19:42.079Z"
  },
  "updatedAt": {
    "$date": "2026-02-10T13:19:42.079Z"
  }
},
{
  "_id": {
    "$oid": "6989f7df0219d4f4d92910cc"
  },
  "name": "CleverTap - Treatment Cycle Started",
  "direction": "OUTBOUND",
  "type": "TREATMENT_CYCLE_STARTED",
  "tenantId": 145,
  "entityName": "Tenant",
  "scope": "INCLUDE_CHILDREN",
  "targetUrl": "https://api.clevertap.com/1/upload",
  "httpMethod": "POST",
  "outgoingAuthType": "CUSTOM_HEADERS",
  "outgoingAuthConfig": {
    "headers": {
      "X-CleverTap-Account-Id": "TEST-ZW6-58Z-W77Z",
      "X-CleverTap-Passcode": "GCC-JQD-YTEL",
      "Content-Type": "application/json; charset=utf-8"
    }
  },
  "isActive": true,
  "timeoutMs": 30000,
  "retryCount": 3,
  "transformationMode": "SCRIPT",
  "transformation": {
    "script": "let phone = payload.patient?.phone || payload.patientPhone || payload.phone || '';\nif (phone) phone = formatPhone(phone);\nconst identity = phone || payload.patient?.mrn?.documentNumber || payload.patientMRN || '';\nif (!identity) return null;\n\nconst defaultTime = '00:00:00';\nconst toEpochWithTime = (date, time) => {\n  if (!date) return null;\n  const dateStr = String(date);\n  if (time) return epoch(`${dateStr} ${time}`);\n  if (dateStr.includes(' ') || dateStr.includes('T')) return epoch(dateStr);\n  return epoch(`${dateStr} ${defaultTime}`);\n};\nconst addEpochField = (data, key, date, time) => {\n  const ts = toEpochWithTime(date, time);\n  if (ts) data[key] = '$D_' + ts;\n};\n\nconst evtData = {\n  'Event Type': payload.type,\n  'Source': 'source-system',\n  'Entity Name': payload.entityName,\n  'Entity ID': payload.entityRID,\n  'Entity Code': payload.entityCode,\n  'Entity Phone': payload.entityPhone,\n  'Entity Parent ID': payload.entityParentID,\n  'Enterprise Code': payload.enterpriseCode,\n  'Unit ID': payload.unitRID,\n  'User ID': payload.userRID,\n  'Description': payload.description,\n  'Patient Name': payload.patient?.fullName,\n  'Patient Phone': payload.patient?.phone,\n  'Patient MRN': payload.patient?.mrn?.documentNumber,\n  'Patient MRN Sequence': payload.patient?.mrn?.sequenceNumber,\n  'Patient Email': payload.patient?.email,\n  'Patient Address': payload.patient?.address,\n  'Patient Gender': payload.patient?.gender,\n  'Is VIP': payload.patient?.isVIP,\n  'Is International': payload.patient?.isInternational,\n  'Is Mobile Verified': payload.patient?.isMobileNoVerified\n};\n\nif (payload.datetime) evtData['Event DateTime'] = '$D_' + epoch(payload.datetime);\n\naddEpochField(evtData, 'Event DateTime_epoch', payload.datetime);\n\nif (payload.appt) {\n  evtData['Appointment ID'] = payload.appt.apptRID;\n  evtData['Booking Number'] = payload.appt.bookingNumber;\n  evtData['Appointment Status'] = payload.appt.apptStatusName;\n  evtData['Appointment Type'] = payload.appt.apptTypeName;\n  evtData['Doctor Name'] = payload.appt.serviceProviderName;\n  evtData['Doctor Phone'] = payload.appt.serviceProviderPhone;\n  evtData['Doctor ID'] = payload.appt.serviceProviderRID;\n  evtData['Resource Name'] = payload.appt.resourceName;\n  evtData['Consultation Fee'] = payload.appt.consultationFee;\n  evtData['Booking Source'] = payload.appt.bookingSource;\n  evtData['Is Video Consultation'] = payload.appt.isVideoConsultation;\n  evtData['Payment Status'] = payload.appt.paymentStatus;\n  evtData['Token Number'] = payload.appt.tokenNumber;\n  evtData['Appointment Duration'] = payload.appt.apptDuration;\n  if (payload.appt.apptDate && payload.appt.apptTime) {\n    evtData['Appointment DateTime'] = '$D_' + datetime(payload.appt.apptDate, payload.appt.apptTime);\n  }\n  const apptDateTimeEpoch = toEpochWithTime(payload.appt.apptDate, payload.appt.apptTime);\n  if (apptDateTimeEpoch) {\n    evtData['Appointment DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    const apptType = (payload.appt.apptTypeName || '').toLowerCase();\n    if (apptType.includes('first')) {\n      evtData['First Consultation DateTime_epoch'] = '$D_' + apptDateTimeEpoch;\n    }\n  }\n  if (payload.appt.remarks) evtData['Appointment Remarks'] = payload.appt.remarks;\n}\n\nif (payload.visit) {\n  evtData['Visit ID'] = payload.visit.id?.value;\n  evtData['Visit Type'] = payload.visit.typeName;\n  evtData['Visit Status'] = payload.visit.statusName;\n  evtData['Visit Number'] = payload.visit.visitNumber?.documentNumber;\n  evtData['Speciality'] = payload.visit.speciality?.name;\n  evtData['Referred By'] = payload.visit.referredBy;\n  evtData['Consulting Doctor ID'] = payload.visit.consultingDoctor?.value;\n  evtData['Visit Sealed'] = payload.visit.sealed;\n  if (payload.visit.date && payload.visit.time) {\n    evtData['Visit DateTime'] = '$D_' + datetime(payload.visit.date, payload.visit.time);\n  }\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.visit.date, payload.visit.time);\n  const visitType = (payload.visit.typeName || '').toLowerCase();\n  if (visitType.includes('first') && !evtData['First Consultation DateTime_epoch']) {\n    addEpochField(evtData, 'First Consultation DateTime_epoch', payload.visit.date, payload.visit.time);\n  }\n}\n\nif (payload.bill) {\n  evtData['Bill ID'] = payload.bill.billId;\n  evtData['Bill Number'] = payload.bill.billNumber;\n  evtData['Bill Amount'] = payload.bill.billAmount;\n  evtData['Bill Status'] = payload.bill.billStatus;\n  evtData['Payment Mode'] = payload.bill.paymentMode;\n  if (payload.bill.billDate) evtData['Bill Date'] = '$D_' + epoch(payload.bill.billDate);\n  addEpochField(evtData, 'Bill Date_epoch', payload.bill.billDate);\n}\n\nif (payload.Bill && payload.Bill[0]) {\n  const billDetail = payload.Bill[0].billDetail && payload.Bill[0].billDetail[0];\n  addEpochField(evtData, 'Bill Date_epoch', payload.Bill[0].date);\n  addEpochField(evtData, 'Visit Date_epoch', payload.Bill[0].visitDate);\n  if (billDetail?.orderDateTime) {\n    addEpochField(evtData, 'Reports Ready DateTime_epoch', billDetail.orderDateTime);\n  }\n}\n\nif (payload.Advances && payload.Advances[0]) {\n  const advance = payload.Advances[0];\n  addEpochField(evtData, 'Advance Date_epoch', advance.date);\n  addEpochField(evtData, 'Advance Transaction DateTime_epoch', advance.tranDate);\n  addEpochField(evtData, 'Advance Visit Date_epoch', advance.visitDate);\n  addEpochField(evtData, 'Advance Cancellation Date_epoch', advance.cancellationDate);\n}\n\nif (payload.Receipt && payload.Receipt.receipts && payload.Receipt.receipts[0]) {\n  const receipt = payload.Receipt.receipts[0];\n  addEpochField(evtData, 'Receipt Date_epoch', receipt.date);\n  addEpochField(evtData, 'Receipt Transaction DateTime_epoch', receipt.tranDate);\n  addEpochField(evtData, 'Receipt Visit Date_epoch', receipt.visitDate);\n  addEpochField(evtData, 'Receipt Received Date_epoch', receipt.receivedDate);\n  addEpochField(evtData, 'Receipt Cancellation Date_epoch', receipt.cancelDate);\n}\n\nif (payload.issue) {\n  addEpochField(evtData, 'Issue Date_epoch', payload.issue.date);\n  addEpochField(evtData, 'Issue Transaction DateTime_epoch', payload.issue.tranDate);\n  addEpochField(evtData, 'Issue Visit Date_epoch', payload.issue.visitDate);\n  if (payload.issue.details && payload.issue.details[0]) {\n    addEpochField(evtData, 'Issue Item Expiry Date_epoch', payload.issue.details[0].expDate);\n  }\n}\n\nif (payload.labReport) {\n  const reportHeader = payload.labReport.reportHeader || {};\n  addEpochField(\n    evtData,\n    'Lab Report DateTime_epoch',\n    reportHeader.reportDate || payload.labReport.reportDate\n  );\n  addEpochField(evtData, 'Lab Report Signed DateTime_epoch', reportHeader.signedDateTime);\n  addEpochField(evtData, 'Lab Report Issued DateTime_epoch', reportHeader.issueDateTime);\n}\n\nif (payload.treatmentAdvise) {\n  evtData['Treatment Type'] = payload.treatmentAdvise.treatmentType;\n  evtData['Treatment Advise By'] = payload.treatmentAdvise.treatmentAdviseBy;\n  evtData['Treatment Advise ID'] = payload.treatmentAdvise.treatmentAdviseId;\n  if (payload.treatmentAdvise.treatmentAdviseDate) {\n    evtData['Treatment Advise Date'] = '$D_' + epoch(payload.treatmentAdvise.treatmentAdviseDate);\n  }\n  const adviseEpoch = toEpochWithTime(payload.treatmentAdvise.treatmentAdviseDate);\n  if (adviseEpoch) {\n    evtData['Treatment Advise Date_epoch'] = '$D_' + adviseEpoch;\n    const treatmentType = (payload.treatmentAdvise.treatmentType || '').toLowerCase();\n    if (treatmentType.includes('ivf')) {\n      evtData['IVF Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IVF Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n    if (treatmentType.includes('iui')) {\n      evtData['IUI Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n      evtData['IUI Procedure Advised DateTime_epoch'] = '$D_' + adviseEpoch;\n    }\n  }\n}\n\nif (payload.consentReceived) {\n  evtData['Treatment Type'] = payload.consentReceived.treatmentType;\n  evtData['Doctor'] = payload.consentReceived.doctor;\n  evtData['Assistant Doctor'] = payload.consentReceived.assistantDoctor;\n  evtData['Counsellor'] = payload.consentReceived.counsellor;\n  evtData['Coordinator'] = payload.consentReceived.coordinator;\n  if (payload.consentReceived.consentReceivedOn) {\n    evtData['Consent Received On'] = '$D_' + epoch(payload.consentReceived.consentReceivedOn);\n  }\n  addEpochField(evtData, 'Consent Received On_epoch', payload.consentReceived.consentReceivedOn);\n}\n\nif (payload.treatmentCycle) {\n  evtData['Treatment Type'] = payload.treatmentCycle.treatmentType;\n  evtData['Treatment Specification'] = payload.treatmentCycle.treatmentspecification;\n  evtData['Doctor'] = payload.treatmentCycle.doctor;\n  if (payload.treatmentCycle.treatmentStartDate) {\n    evtData['Treatment Start Date'] = '$D_' + epoch(payload.treatmentCycle.treatmentStartDate);\n  }\n  addEpochField(evtData, 'Treatment Start Date_epoch', payload.treatmentCycle.treatmentStartDate);\n}\n\nif (payload.treatmentChart) {\n  evtData['Chart ID'] = payload.treatmentChart.chartId;\n  evtData['Protocol Name'] = payload.treatmentChart.protocolName;\n  if (payload.treatmentChart.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChart.stimulationStartedOn);\n  }\n  addEpochField(evtData, 'Stimulation Started On_epoch', payload.treatmentChart.stimulationStartedOn);\n  addEpochField(\n    evtData,\n    'Mensural Cycle DateTime_epoch',\n    payload.treatmentChart.stimulationStartedOn\n  );\n  addEpochField(\n    evtData,\n    'OPU Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n  addEpochField(\n    evtData,\n    'IVF Procedure Scheduled DateTime_epoch',\n    payload.treatmentChart.OPUScheduledOn,\n    payload.treatmentChart.OPUScheduledAt\n  );\n}\n\nif (payload.treatmentChartMedicationEvent) {\n  evtData['Chart ID'] = payload.treatmentChartMedicationEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartMedicationEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartMedicationEvent.stimulationDay;\n  evtData['Medication Recorded'] = payload.treatmentChartMedicationEvent.medicationRecorded;\n  if (payload.treatmentChartMedicationEvent.stimulationDate) {\n    evtData['Stimulation Date'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationDate);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Date_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  addEpochField(\n    evtData,\n    'Prescription Generated DateTime_epoch',\n    payload.treatmentChartMedicationEvent.stimulationDate\n  );\n  if (payload.treatmentChartMedicationEvent.stimulationStartedOn) {\n    evtData['Stimulation Started On'] = '$D_' + epoch(payload.treatmentChartMedicationEvent.stimulationStartedOn);\n  }\n  addEpochField(\n    evtData,\n    'Stimulation Started On_epoch',\n    payload.treatmentChartMedicationEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentChartScanEvent) {\n  evtData['Chart ID'] = payload.treatmentChartScanEvent.chartId;\n  evtData['Protocol Name'] = payload.treatmentChartScanEvent.protocolName;\n  evtData['Stimulation Day'] = payload.treatmentChartScanEvent.stimulationDay;\n  evtData['Scan Recorded'] = payload.treatmentChartScanEvent.scanRecorded;\n  const scanDate = payload.treatmentChartScanEvent.scanDate || payload.treatmentChartScanEvent.stimulationDate;\n  if (scanDate) {\n    evtData['Scan Date'] = '$D_' + epoch(scanDate);\n  }\n  addEpochField(evtData, 'Scan DateTime_epoch', scanDate);\n  addEpochField(\n    evtData,\n    'Scan Scheduled DateTime_epoch',\n    payload.treatmentChartScanEvent.stimulationStartedOn\n  );\n}\n\nif (payload.treatmentCycleTrigger) {\n  addEpochField(\n    evtData,\n    'Injection 1 DateTime_epoch',\n    payload.treatmentCycleTrigger.firstTriggeredDate,\n    payload.treatmentCycleTrigger.firstTriggeredTime\n  );\n  addEpochField(\n    evtData,\n    'Injection 2 DateTime_epoch',\n    payload.treatmentCycleTrigger.secondTriggeredDate,\n    payload.treatmentCycleTrigger.secondTriggeredTime\n  );\n}\n\nif (payload.OPU) {\n  if (payload.OPU.opuDoneDate) evtData['OPU Done Date'] = '$D_' + epoch(payload.OPU.opuDoneDate);\n  if (payload.OPU.opuScheduledDate) evtData['OPU Scheduled Date'] = '$D_' + epoch(payload.OPU.opuScheduledDate);\n  addEpochField(evtData, 'OPU Done DateTime_epoch', payload.OPU.opuDoneDate);\n  addEpochField(evtData, 'OPU Scheduled DateTime_epoch', payload.OPU.opuScheduledDate);\n}\n\nif (payload.IUI) {\n  if (payload.IUI.iuiDoneDate) evtData['IUI Done Date'] = '$D_' + epoch(payload.IUI.iuiDoneDate);\n  if (payload.IUI.iuiScheduledDate) evtData['IUI Scheduled Date'] = '$D_' + epoch(payload.IUI.iuiScheduledDate);\n  addEpochField(evtData, 'IUI Done DateTime_epoch', payload.IUI.iuiDoneDate);\n  addEpochField(evtData, 'IUI Scheduled DateTime_epoch', payload.IUI.iuiScheduledDate);\n}\n\nif (payload.iuiScheduled) {\n  addEpochField(\n    evtData,\n    'IUI Scheduled DateTime_epoch',\n    payload.iuiScheduled.IUIScheduledOn,\n    payload.iuiScheduled.IUIScheduledAt\n  );\n}\n\nif (payload.iuiRecord) {\n  addEpochField(\n    evtData,\n    'IUI Done DateTime_epoch',\n    payload.iuiRecord.iuiDoneDate\n  );\n}\n\nif (payload.ET) {\n  if (payload.ET.etDoneDate) evtData['ET Done Date'] = '$D_' + epoch(payload.ET.etDoneDate);\n  if (payload.ET.etScheduledDate) evtData['ET Scheduled Date'] = '$D_' + epoch(payload.ET.etScheduledDate);\n  addEpochField(evtData, 'ET Done DateTime_epoch', payload.ET.etDoneDate);\n  addEpochField(evtData, 'ET Scheduled DateTime_epoch', payload.ET.etScheduledDate);\n}\n\nif (payload.etSchedule) {\n  addEpochField(\n    evtData,\n    'ET Scheduled DateTime_epoch',\n    payload.etSchedule.ETScheduledOn,\n    payload.etSchedule.ETScheduledAt\n  );\n}\n\nif (payload.betaHCG) {\n  evtData['Beta HCG Value'] = payload.betaHCG.value;\n  evtData['Beta HCG Result'] = payload.betaHCG.result;\n  if (payload.betaHCG.testDate) evtData['Beta HCG Test Date'] = '$D_' + epoch(payload.betaHCG.testDate);\n  addEpochField(evtData, 'Beta HCG Test DateTime_epoch', payload.betaHCG.testDate);\n  if (payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCG.recommendedDate || payload.betaHCG.recommendedOn,\n      payload.betaHCG.recommendedTime\n    );\n  }\n}\n\nif (payload.betaHCGRecord) {\n  if (payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn) {\n    addEpochField(\n      evtData,\n      'Beta HCG Recommended DateTime_epoch',\n      payload.betaHCGRecord.recommendedDate || payload.betaHCGRecord.recommendedOn,\n      payload.betaHCGRecord.recommendedTime\n    );\n  }\n  if (!evtData['B-HCG+ Record DateTime_epoch']) {\n    addEpochField(\n      evtData,\n      'B-HCG+ Record DateTime_epoch',\n      payload.betaHCGRecord.recordedDate ||\n        payload.betaHCGRecord.recordedOn ||\n        payload.betaHCGRecord.testDate,\n      payload.betaHCGRecord.recordedTime || payload.betaHCGRecord.testTime\n    );\n  }\n}\nif (payload.type === 'BETA_HCG_RECORD' && !evtData['B-HCG+ Record DateTime_epoch']) {\n  addEpochField(evtData, 'B-HCG+ Record DateTime_epoch', payload.datetime);\n}\n\nif (payload.pregnancy) {\n  evtData['Pregnancy Status'] = payload.pregnancy.status;\n  evtData['Pregnancy Type'] = payload.pregnancy.type;\n  if (payload.pregnancy.confirmedDate) evtData['Pregnancy Confirmed Date'] = '$D_' + epoch(payload.pregnancy.confirmedDate);\n  addEpochField(evtData, 'Pregnancy Confirmed Date_epoch', payload.pregnancy.confirmedDate);\n}\n\nif (payload.clinicalPregnancyRecord) {\n  addEpochField(\n    evtData,\n    'Sac Implantation DateTime_epoch',\n    payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n  );\n  const sacStatus = (payload.clinicalPregnancyRecord.sacImplimention || '').toLowerCase();\n  if (sacStatus.includes('fail')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Failure DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n  if (sacStatus.includes('success')) {\n    addEpochField(\n      evtData,\n      'Sac Implantation Successful DateTime_epoch',\n      payload.clinicalPregnancyRecord.clinicalPregnanyRecordedOn\n    );\n  }\n}\n\nif (payload.liveBirth) {\n  evtData['Number of Babies'] = payload.liveBirth.numberOfBabies;\n  evtData['Delivery Type'] = payload.liveBirth.deliveryType;\n  if (payload.liveBirth.deliveryDate) evtData['Delivery Date'] = '$D_' + epoch(payload.liveBirth.deliveryDate);\n  addEpochField(evtData, 'Delivery Date_epoch', payload.liveBirth.deliveryDate);\n  addEpochField(\n    evtData,\n    'Birth Details Recorded DateTime_epoch',\n    payload.liveBirth.birthDetailsRecordedDate\n  );\n}\n\nif (payload.miscarriage) {\n  evtData['Miscarriage Reason'] = payload.miscarriage.reason;\n  if (payload.miscarriage.recordedDate) evtData['Miscarriage Date'] = '$D_' + epoch(payload.miscarriage.recordedDate);\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.miscarriage.recordedDate);\n}\n\nif (payload.treatmentCycleStopped) {\n  addEpochField(\n    evtData,\n    'Cycle Cancellation DateTime_epoch',\n    payload.treatmentCycleStopped.treatmentStoppedOn\n  );\n}\n\nif (payload.cycleCompletion) {\n  evtData['Cycle Status'] = payload.cycleCompletion.status;\n  evtData['Cycle Result'] = payload.cycleCompletion.result;\n  if (payload.cycleCompletion.completedDate) evtData['Cycle Completed Date'] = '$D_' + epoch(payload.cycleCompletion.completedDate);\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.cycleCompletion.completedDate);\n}\n\nif (payload.type === 'CYCLE_COMPLETED' && !evtData['Cycle Completed Date_epoch']) {\n  addEpochField(evtData, 'Cycle Completed Date_epoch', payload.datetime);\n}\nif (payload.type === 'MISCARRIAGE_RECORDED' && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif (payload.pregnancyMiscarriage && !evtData['Miscarriage Date_epoch']) {\n  addEpochField(evtData, 'Miscarriage Date_epoch', payload.datetime);\n}\nif ((payload.type === 'OP_REFERRAL_DOCTOR_EVENT' || payload.type === 'OP_VISIT_MODIFIED') && !evtData['Visit DateTime_epoch']) {\n  addEpochField(evtData, 'Visit DateTime_epoch', payload.datetime);\n}\nif (payload.type === 'PATIENT_REGISTERED' && !evtData['Patient Registered DateTime_epoch']) {\n  addEpochField(evtData, 'Patient Registered DateTime_epoch', payload.datetime);\n}\nObject.keys(evtData).forEach(key => {\n  if (evtData[key] === null || evtData[key] === undefined) {\n    delete evtData[key];\n  }\n});\n\nconst timestamp = Math.floor(Date.now() / 1000);\nreturn { d: [{ identity: identity, ts: timestamp, type: 'event', evtName: payload.type, evtData: evtData }] };\n"
  },
  "circuitOpenedAt": null,
  "circuitState": "CLOSED",
  "consecutiveFailures": 0,
  "lastSuccessAt": {
    "$date": "2026-02-10T13:19:10.191Z"
  },
  "updatedAt": {
    "$date": "2026-02-10T13:19:10.191Z"
  }
},
{
  "_id": {
    "$oid": "698ea1084dcb5474ed205fe5"
  },
  "tenantId": 145,
  "name": "test",
  "type": "test",
  "direction": "INBOUND",
  "targetUrl": null,
  "httpMethod": "POST",
  "inboundAuthType": "NONE",
  "inboundAuthConfig": {},
  "outgoingAuthType": "NONE",
  "outgoingAuthConfig": {},
  "requestTransformation": {
    "mode": "SCRIPT",
    "script": ""
  },
  "responseTransformation": {
    "mode": "SCRIPT",
    "script": ""
  },
  "streamResponse": false,
  "rateLimits": null,
  "timeout": 10000,
  "retryCount": 3,
  "contentType": "application/json",
  "isActive": true,
  "actions": [
    {
      "name": "Send EMAIL",
      "kind": "COMMUNICATION",
      "communicationConfig": {
        "channel": "EMAIL",
        "provider": "SMTP",
        "smtp": {
          "host": "smtp.bzsecure.in",
          "port": 587,
          "username": " purchase@unityhospital.in",
          "password": "Republic@2026",
          "fromEmail": "purchase@unityhospital.in"
        }
      }
    }
  ],
  "createdAt": {
    "$date": "2026-02-13T03:56:56.748Z"
  },
  "updatedAt": {
    "$date": "2026-02-13T05:32:32.831Z"
  },
  "createdBy": "system"
}]